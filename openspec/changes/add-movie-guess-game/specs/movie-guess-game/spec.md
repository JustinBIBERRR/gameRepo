## ADDED Requirements

### Requirement: 电影随机选择
系统 SHALL 从电影列表中随机选择一个目标电影。

#### Scenario: 开始新游戏
- **WHEN** 用户开始电影猜测游戏
- **THEN** 系统随机选择一部电影作为目标
- **AND** 目标电影对用户隐藏
- **AND** 系统显示电影总时长作为参考

### Requirement: 时间点选择
系统 SHALL 允许用户通过时间轴拖拽或数字输入来选择要播放的音频片段。

#### Scenario: 用户通过时间轴拖拽选择时间点
- **WHEN** 用户拖拽时间轴滑块
- **THEN** 系统实时更新显示的时间点（分钟:秒格式）
- **AND** 数字输入框自动同步更新
- **AND** 系统验证时间点是否在有效范围内（不能超过电影总时长）

#### Scenario: 用户通过数字输入选择时间点
- **WHEN** 用户输入分钟和秒数
- **THEN** 系统验证时间点是否在有效范围内（不能超过电影总时长）
- **AND** 时间轴滑块自动同步更新位置
- **AND** 如果时间点无效，系统显示错误提示

#### Scenario: 时间点超出范围处理
- **WHEN** 用户选择的时间点+15秒超过电影总时长
- **THEN** 系统自动调整播放时长为剩余时长
- **AND** 如果时间点本身超过总时长，系统显示错误提示

### Requirement: 音频片段播放
系统 SHALL 从用户指定的时间点开始播放15秒的电影音频，猜测阶段不显示视频画面，并限制每个时间点的播放次数。

#### Scenario: 播放音频片段（未达上限）
- **WHEN** 用户选择时间点并点击"播放音频"按钮
- **THEN** 系统检查该时间点的播放次数是否已达上限（从设置中读取）
- **AND** 如果未达上限，系统从指定时间点开始播放音频
- **AND** 播放时长为15秒
- **AND** 播放过程中不显示视频画面（仅音频）
- **AND** 播放器显示播放进度和剩余时间
- **AND** 该时间点的播放次数+1
- **AND** 用户可以在播放过程中暂停或重新播放

#### Scenario: 播放音频片段（已达上限）
- **WHEN** 用户选择时间点并点击"播放音频"按钮
- **THEN** 系统检查该时间点的播放次数是否已达上限
- **AND** 如果已达上限，系统显示提示信息（如"该片段已达到最大播放次数"）
- **AND** 不允许播放，提示用户选择其他时间点

#### Scenario: 音频播放失败
- **WHEN** 音频加载或播放失败
- **THEN** 系统显示错误提示
- **AND** 该时间点的播放次数不增加
- **AND** 允许用户重新选择时间点或重新播放

### Requirement: 电影名称猜测
系统 SHALL 允许用户输入电影名称进行猜测，支持精确匹配、预设别名匹配和模糊匹配。

#### Scenario: 用户提交猜测（精确匹配）
- **WHEN** 用户输入电影名称并提交
- **THEN** 系统首先尝试精确匹配（完全匹配电影名称）
- **AND** 如果精确匹配成功，判定猜测正确，消耗一次猜测机会

#### Scenario: 用户提交猜测（别名匹配）
- **WHEN** 用户输入电影名称并提交
- **THEN** 如果精确匹配失败，系统尝试预设别名匹配
- **AND** 如果匹配到预设别名（如"哪吒"匹配"哪吒之魔童降世"），判定猜测正确，消耗一次猜测机会

#### Scenario: 用户提交猜测（模糊匹配）
- **WHEN** 用户输入电影名称并提交
- **THEN** 如果别名匹配失败，系统尝试模糊匹配（忽略大小写、空格、标点符号）
- **AND** 如果模糊匹配成功，判定猜测正确，消耗一次猜测机会
- **AND** 如果所有匹配都失败，提示用户重新输入且不消耗机会

### Requirement: 猜测历史记录
系统 SHALL 记录每次猜测的时间点、猜测的电影名称和结果。

#### Scenario: 记录猜测历史
- **WHEN** 用户提交有效猜测后
- **THEN** 系统将猜测信息添加到历史记录
- **AND** 历史记录包含：时间点（分钟:秒格式）、猜测的电影名称、是否正确
- **AND** 历史记录按时间顺序显示

### Requirement: 游戏成功
系统 SHALL 在用户正确猜测目标电影时判定游戏成功。

#### Scenario: 猜测成功
- **WHEN** 用户输入的电影名称与目标电影匹配
- **THEN** 系统显示成功消息
- **AND** 游戏结束
- **AND** 停止倒计时
- **AND** 更新游戏统计
- **AND** 提供重新开始游戏的选项

### Requirement: 游戏失败
系统 SHALL 在用户用尽猜测机会仍未猜中时判定游戏失败。

#### Scenario: 猜测失败
- **WHEN** 用户已使用所有猜测机会且未猜中
- **THEN** 系统显示失败消息并揭示目标电影
- **AND** 游戏结束
- **AND** 停止倒计时
- **AND** 更新游戏统计
- **AND** 提供重新开始游戏的选项

### Requirement: 视频片段回顾
系统 SHALL 在游戏结束后允许用户回顾所有猜测时选择的视频片段。

#### Scenario: 显示回顾功能
- **WHEN** 游戏结束（成功或失败）
- **THEN** 系统显示猜测历史记录列表
- **AND** 每个历史项显示：时间点、猜测的电影名称、是否正确
- **AND** 用户点击历史项时，系统播放对应的视频片段（15秒，显示视频画面）

#### Scenario: 播放回顾视频
- **WHEN** 用户点击历史记录中的某个猜测项
- **THEN** 系统从该猜测的时间点开始播放视频片段
- **AND** 播放时长为15秒
- **AND** 播放过程中显示视频画面（与猜测阶段不同）
- **AND** 用户可以暂停、重新播放或切换到其他历史项

### Requirement: 游戏配置和本地文件管理
系统 SHALL 支持在设置页面配置电影猜测游戏的参数，并为每部电影配置本地视频文件。

#### Scenario: 读取游戏配置
- **WHEN** 用户开始电影猜测游戏
- **THEN** 系统从设置中读取最大尝试次数（优先使用游戏类型覆盖，否则使用全局默认值）
- **AND** 系统从设置中读取每个片段的最大播放次数（优先使用游戏类型覆盖，否则使用全局默认值）
- **AND** 如果未配置，使用默认值（最大尝试次数：8次，最大播放次数：待定）

#### Scenario: 配置游戏设置
- **WHEN** 用户在设置页面修改电影猜测游戏的配置
- **THEN** 系统保存配置到 localStorage
- **AND** 配置项包括：最大尝试次数、每个片段的最大播放次数、倒计时时长等
- **AND** 新游戏使用更新后的配置

#### Scenario: 配置本地电影文件（小文件）
- **WHEN** 用户在设置页面为某部电影选择本地视频文件
- **THEN** 系统显示文件选择器（限制为MP4格式）
- **AND** 系统检测文件大小
- **AND** 如果文件<5GB，系统直接保存File对象到IndexedDB
- **AND** 系统显示已配置的文件信息（文件名、大小）

#### Scenario: 配置本地电影文件（混合方案）
- **WHEN** 用户在设置页面选择电影文件
- **THEN** 系统检测文件大小
- **AND** 如果文件>10GB（如30GB），系统提供两种配置选项：
  - **选项1**：仅配置原文件（支持精确时间点，30秒内加载）
  - **选项2**：配置原文件 + 关键片段（快速+精确混合）
- **AND** 如果选择选项2，系统提示用户使用FFmpeg脚本预处理关键片段
- **AND** 系统提供切片脚本下载和说明文档
- **AND** 用户完成配置后，系统保存到IndexedDB：
  - 原文件（File对象）
  - 关键片段数组（如果提供）
  - 播放模式偏好（快速/精确/自动）

#### Scenario: 文件配置验证
- **WHEN** 游戏需要播放某部电影但未配置本地文件
- **THEN** 系统提示用户在设置页面配置该电影的文件
- **AND** 系统提供快速跳转到设置页面的链接
- **AND** 游戏无法开始，直到文件配置完成

### Requirement: 倒计时集成
系统 SHALL 集成倒计时功能，倒计时结束时自动判定游戏失败。

#### Scenario: 倒计时启动
- **WHEN** 用户开始电影猜测游戏
- **THEN** 系统从设置中读取倒计时时长
- **AND** 启动倒计时
- **AND** 在游戏页面显示倒计时

#### Scenario: 倒计时超时
- **WHEN** 倒计时结束时用户仍未猜中
- **THEN** 系统自动判定游戏失败
- **AND** 显示超时提示
- **AND** 揭示目标电影

### Requirement: 游戏状态持久化
系统 SHALL 使用 sessionStorage 保存游戏状态，支持页面刷新后恢复进度。

#### Scenario: 保存游戏状态
- **WHEN** 用户进行游戏（选择目标、提交猜测等）
- **THEN** 系统将当前游戏状态保存到 sessionStorage
- **AND** 保存内容包括：目标电影、已猜测次数、猜测历史记录、每个时间点的播放次数、倒计时状态

#### Scenario: 恢复游戏状态
- **WHEN** 用户刷新页面
- **THEN** 系统从 sessionStorage 读取游戏状态
- **AND** 恢复目标电影、已猜测次数、猜测历史、每个时间点的播放次数和倒计时状态
- **AND** 用户可以继续之前的游戏

#### Scenario: 重新开始游戏
- **WHEN** 用户关闭标签页后重新打开
- **THEN** sessionStorage 自动清除
- **AND** 游戏重新开始，随机选择新的目标电影

### Requirement: 游戏统计集成
系统 SHALL 记录电影猜测游戏的统计数据，包括总游戏数、胜利数、失败数等。

#### Scenario: 更新游戏统计
- **WHEN** 游戏结束（成功或失败）
- **THEN** 系统更新游戏统计数据
- **AND** 统计数据包括：总游戏数、胜利数、失败数、最佳成绩、平均尝试次数、连胜记录等

### Requirement: 平台集成
系统 SHALL 将电影猜测游戏集成到游戏平台，包括首页入口和路由配置。

#### Scenario: 首页显示游戏
- **WHEN** 用户访问平台首页
- **THEN** 系统显示电影猜测游戏卡片
- **AND** 游戏卡片包含游戏名称、描述和图标
- **AND** 用户点击卡片可进入游戏页面

#### Scenario: 路由配置
- **WHEN** 用户访问 `/movie-guess` 路由
- **THEN** 系统加载电影猜测游戏页面
- **AND** 游戏页面正确显示和运行

### Requirement: 本地视频文件支持
系统 SHALL 支持用户提供本地视频文件，通过File API和IndexedDB管理。

#### Scenario: 用户在设置页面选择本地文件
- **WHEN** 用户在设置页面为某部电影选择本地视频文件
- **THEN** 系统通过文件选择器让用户选择MP4文件
- **AND** 系统将File对象保存到IndexedDB
- **AND** 系统显示文件名和文件大小
- **AND** 文件配置与电影ID关联

#### Scenario: 游戏时加载本地文件
- **WHEN** 用户开始游戏，系统需要播放目标电影
- **THEN** 系统从IndexedDB读取对应的视频片段配置
- **AND** 如果片段配置不存在，提示用户在设置页面配置
- **AND** 系统显示电影总时长（从片段配置中获取）
- **AND** 用户选择时间点时，系统找到最接近的切片片段
- **AND** 系统加载对应的15秒视频片段（1-3秒）
- **AND** 加载完成后可以正常播放

#### Scenario: 视频切片验证
- **WHEN** 用户在设置页面选择本地视频文件
- **THEN** 系统检测文件大小
- **AND** 如果文件>10GB，系统提示用户需要预处理切片
- **AND** 系统提供FFmpeg切片脚本和说明
- **AND** 用户完成切片后，系统读取切片文件并保存配置

#### Scenario: 音频模式播放（快速模式 - 关键片段）
- **WHEN** 用户在猜测阶段播放音频，选择的时间点接近关键片段（±2.5分钟）
- **THEN** 系统找到最接近的关键片段（如55分钟 = 3300秒的片段）
- **AND** 系统显示加载状态："正在加载视频片段..."
- **AND** 系统加载对应的15秒视频片段（1-3秒，文件大小50-200MB）
- **AND** 系统使用HTML5 video元素加载片段文件
- **AND** 系统通过CSS隐藏视频画面（只显示音频播放器界面）
- **AND** 系统播放15秒后自动暂停
- **AND** 播放过程中显示播放进度和剩余时间

#### Scenario: 音频模式播放（精确模式 - 原文件）
- **WHEN** 用户在猜测阶段播放音频，选择精确时间点或远离关键片段的时间点
- **THEN** 系统使用原文件（30GB）
- **AND** 系统显示加载状态："正在跳转到55分20秒...（预计10-30秒）"
- **AND** 系统使用 `preload="metadata"` 快速加载元数据（<2秒）
- **AND** 系统使用 `video.currentTime` 跳转到目标时间点
- **AND** 浏览器自动使用Range请求加载对应部分
- **AND** 系统显示加载进度条
- **AND** 当有足够数据可以播放时（`canplay`事件，通常在30秒内），系统自动开始播放
- **AND** 系统通过CSS隐藏视频画面（只显示音频播放器界面）
- **AND** 系统播放15秒后自动暂停
- **AND** 播放过程中显示播放进度和剩余时间

#### Scenario: 视频模式播放（回顾阶段）
- **WHEN** 用户在回顾阶段查看视频片段
- **THEN** 系统使用同一个video元素
- **AND** 系统显示视频画面（移除CSS隐藏）
- **AND** 系统跳转到对应时间点播放15秒视频
- **AND** 用户可以暂停、重播或切换到其他片段
