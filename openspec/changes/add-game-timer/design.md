# Design: 游戏倒计时功能

## 架构概述

倒计时功能分为三个主要部分：
1. **全局设置页面**：独立的设置页面，管理全局默认值和游戏类型覆盖
2. **倒计时设置**：全局默认值 + 游戏类型覆盖（城市猜测、英雄猜测可分别配置）
3. **游戏倒计时**：在游戏页面显示和运行，支持状态恢复

## 组件设计

### 1. Settings 页面
- **位置**：独立路由页面（/settings）
- **入口**：Navigation 组件中的设置图标
- **功能**：
  - 显示全局默认设置（倒计时时长、尝试次数、初始提示）
  - 显示游戏类型覆盖设置（城市猜测、英雄猜测）
  - 提供输入框和开关供用户修改
  - 验证输入（倒计时：1-60分钟，尝试次数：3-10次）
  - 保存设置到 localStorage
- **布局**：
  - 全局默认设置区域（顶部）
  - 游戏类型覆盖区域（下方，可折叠）
  - 每个游戏类型显示独立的配置项

### 2. TimerRestoreTip 组件
- **位置**：游戏页面顶部居中悬浮
- **功能**：
  - 显示倒计时恢复提示
  - 内容："倒计时已恢复，剩余时间：XX:XX，或者看广告延长时间，QAQ骗你的没广告~"
  - 自动显示3秒后消失
- **样式**：
  - 位置：页面顶部居中
  - 宽度：约占屏幕40%
  - 颜色：蓝色背景
  - 图标：前置感叹号图标
  - 动画：渐变出现和隐藏（fade in/out）

### 2. GameTimer 组件
- **位置**：游戏页面顶部（HeroGuess/CityGuess）
- **功能**：
  - 显示倒计时（格式：MM:SS）
  - 倒计时结束时触发回调
  - 视觉提示（剩余时间少于1分钟时变红）
- **Props**：
  - `duration`: 倒计时时长（秒）
  - `onTimeout`: 超时回调函数

### 3. useTimer Composable
- **功能**：
  - 管理倒计时状态
  - 处理倒计时逻辑（开始、暂停、重置）
  - 计算剩余时间
  - 处理页面可见性变化（标签页切换时暂停）
- **返回值**：
  - `timeRemaining`: 剩余时间（秒）
  - `isRunning`: 是否正在运行
  - `start()`: 开始倒计时
  - `pause()`: 暂停倒计时
  - `reset()`: 重置倒计时
  - `onTimeout`: 超时回调

## 数据流

1. **设置流程**：
   - 用户在首页或游戏页面修改倒计时设置
   - 设置保存到 localStorage
   - 如果游戏正在进行，立即更新当前倒计时

2. **游戏流程**：
   - 用户进入游戏页面
   - 从 localStorage 读取倒计时设置
   - 游戏开始时启动倒计时
   - 倒计时结束时触发游戏失败逻辑
   - 显示超时弹框

3. **重置流程**：
   - 用户开始新游戏时重置倒计时
   - 用户修改设置时重置倒计时

## 存储设计

### localStorage 键
- `gameSettings`: 存储游戏设置
  ```typescript
  {
    // 全局默认值
    defaults: {
      timerDuration: number,      // 倒计时时长（分钟），默认5
      maxAttempts: number,         // 最大尝试次数，默认5
      showInitialHint: boolean     // 是否显示初始提示，默认true
    },
    // 游戏类型覆盖
    overrides: {
      city: {
        timerDuration?: number,
        maxAttempts?: number,
        showInitialHint?: boolean
      },
      hero: {
        timerDuration?: number,
        maxAttempts?: number,
        showInitialHint?: boolean
      }
    }
  }
  ```

### sessionStorage 键
- `gameTimerState`: 存储倒计时状态（用于恢复）
  ```typescript
  {
    gameType: 'city' | 'hero',
    startTime: number,        // 倒计时开始时间戳
    remainingSeconds: number, // 剩余秒数
    isRunning: boolean        // 是否正在运行
  }
  ```

## 集成点

### 游戏页面集成
- 在 `CityGuess.vue` 和 `HeroGuess.vue` 中：
  1. 从设置中读取配置（优先使用游戏类型覆盖，否则使用全局默认值）
  2. 导入 `useTimer` composable
  3. 在游戏开始时启动倒计时
  4. 在游戏成功/失败时停止倒计时
  5. 在开始新游戏时重置倒计时
  6. 处理超时事件（设置 `gameOver = true`）
  7. 处理页面加载时恢复倒计时状态（如果 sessionStorage 中有状态）
  8. 显示倒计时恢复提示（如果从 sessionStorage 恢复）

### 超时处理
- 当倒计时结束时：
  1. 停止倒计时
  2. 设置 `gameOver = true`
  3. 显示超时弹框（使用现有的 `useModal`）
  4. 弹框提供两个选项：
     - "再来一局"：调用 `restartGame()`
     - "回到首页"：使用 `router.push('/')`

## 边界情况处理

1. **页面切换**：
   - 用户切换到其他标签页时，倒计时暂停
   - 用户返回时，倒计时恢复

2. **设置修改**：
   - 游戏进行中修改设置：立即重置倒计时
   - 游戏未开始时修改设置：仅保存设置

3. **游戏提前结束**：
   - 用户猜对答案：停止倒计时
   - 用户用尽尝试次数：停止倒计时

4. **浏览器刷新**：
   - 倒计时状态保存到 sessionStorage
   - 刷新后从 sessionStorage 恢复倒计时状态
   - 显示3秒悬浮提示："倒计时已恢复，剩余时间：XX:XX，或者看广告延长时间，QAQ骗你的没广告~"
   - 提示样式：页面顶部居中，约占屏幕40%宽度，蓝色背景，带感叹号图标，渐变出现和隐藏

## UI/UX 考虑

1. **视觉反馈**：
   - 倒计时显示清晰易读
   - 剩余时间少于1分钟时变红警告
   - 倒计时结束时显示明显的提示

2. **用户体验**：
   - 设置入口明显但不干扰游戏
   - 倒计时显示位置合理（游戏页面顶部）
   - 超时弹框信息清晰，操作明确

## 性能考虑

1. **定时器管理**：
   - 使用 `setInterval` 每秒更新
   - 组件卸载时清理定时器
   - 避免内存泄漏

2. **状态更新**：
   - 使用 Vue 的响应式系统
   - 避免不必要的重新渲染
